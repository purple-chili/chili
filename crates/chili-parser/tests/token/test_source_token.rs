use chili_parser::utils::print_errs;
use chumsky::prelude::*;
use std::path::PathBuf;

#[test]
fn test_pub_token() {
    let mut src_path = PathBuf::from(env!("CARGO_MANIFEST_DIR"));
    src_path.push("tests/chili/src/pub.chi");
    let src_path = src_path.to_str().unwrap();
    let src = std::fs::read_to_string(src_path).unwrap();
    let (tokens, errs) = chili_parser::Token::lexer()
        .parse(&src)
        .into_output_errors();

    if errs.len() > 0 {
        print_errs(errs, src_path, &src);
    }

    let tokens = tokens
        .unwrap()
        .into_iter()
        .map(|(token, span)| format!("{}|{}", token, span.end - span.start))
        .collect::<Vec<String>>();
    assert_eq!(
        tokens,
        vec![
            "Id'h'|1",
            "Op':'|1",
            "Id'.handle.open'|12",
            "Punc'('|1",
            "Symbol'`chili://:18000'|15",
            "Punc')'|1",
            "Punc';'|1",
            "Id'pub'|3",
            "Op':'|1",
            "Fn|8",
            "Punc'('|1",
            "Punc')'|1",
            "Punc'{'|1",
            "Id'n'|1",
            "Op':'|1",
            "Int'10'|2",
            "Punc';'|1",
            "Id'.log.info'|9",
            "Punc'('|1",
            "Punc'['|1",
            "Str'publish'|9",
            "Punc','|1",
            "Id'n'|1",
            "Punc','|1",
            "Str'record'|8",
            "Punc']'|1",
            "Punc')'|1",
            "Punc';'|1",
            "Id'h'|1",
            "Punc'('|1",
            "Punc'['|1",
            "Symbol'`.tick.upd'|10",
            "Punc','|1",
            "Symbol'`trade'|6",
            "Punc','|1",
            "Punc'('|1",
            "Punc'['|1",
            "Punc']'|1",
            "Id'sym'|3",
            "Op':'|1",
            "Id'n'|1",
            "Op'?'|1",
            "Symbol'`a`b`c'|6",
            "Punc','|1",
            "Id'price'|5",
            "Op':'|1",
            "Id'n'|1",
            "Op'?'|1",
            "Float'1.0'|3",
            "Punc','|1",
            "Id'size'|4",
            "Op':'|1",
            "Id'n'|1",
            "Op'?'|1",
            "Int'10'|2",
            "Punc','|1",
            "Id'side'|4",
            "Op':'|1",
            "Id'n'|1",
            "Op'?'|1",
            "Symbol'`B`S'|4",
            "Punc','|1",
            "Id'time'|4",
            "Op':'|1",
            "Id'n'|1",
            "Op'#'|1",
            "Id'now'|3",
            "Punc'('|1",
            "Symbol'`'|1",
            "Punc')'|1",
            "Punc')'|1",
            "Punc']'|1",
            "Punc')'|1",
            "Punc';'|1",
            "Id'h'|1",
            "Punc'('|1",
            "Punc'['|1",
            "Symbol'`.tick.upd'|10",
            "Punc','|1",
            "Symbol'`quote'|6",
            "Punc','|1",
            "Punc'('|1",
            "Punc'['|1",
            "Punc']'|1",
            "Id'sym'|3",
            "Op':'|1",
            "Id'n'|1",
            "Op'?'|1",
            "Symbol'`a`b`c'|6",
            "Punc','|1",
            "Id'bid'|3",
            "Op':'|1",
            "Id'n'|1",
            "Op'?'|1",
            "Float'1.0'|3",
            "Punc','|1",
            "Id'ask'|3",
            "Op':'|1",
            "Id'n'|1",
            "Op'?'|1",
            "Float'1.0'|3",
            "Punc','|1",
            "Id'time'|4",
            "Op':'|1",
            "Id'n'|1",
            "Op'#'|1",
            "Id'now'|3",
            "Punc'('|1",
            "Symbol'`'|1",
            "Punc')'|1",
            "Punc')'|1",
            "Punc']'|1",
            "Punc')'|1",
            "Punc';'|1",
            "Punc'}'|1",
            "Punc';'|1",
            "Id'.job.add'|8",
            "Punc'('|1",
            "Str'pub'|5",
            "Punc','|1",
            "Id'now'|3",
            "Punc'('|1",
            "Symbol'`'|1",
            "Punc')'|1",
            "Punc','|1",
            "Id'now'|3",
            "Punc'('|1",
            "Symbol'`'|1",
            "Punc')'|1",
            "Op'+'|1",
            "Duration'1D00:00:00'|10",
            "Punc','|1",
            "Duration'0D00:00:01'|10",
            "Punc','|1",
            "Str'publish'|9",
            "Punc')'|1",
            "Punc';'|1"
        ]
    )
}

#[test]
fn test_sub() {
    let mut src_path = PathBuf::from(env!("CARGO_MANIFEST_DIR"));
    src_path.push("tests/chili/src/sub.chi");
    let src_path = src_path.to_str().unwrap();
    let src = std::fs::read_to_string(src_path).unwrap();
    let (tokens, errs) = chili_parser::Token::lexer()
        .parse(&src)
        .into_output_errors();

    if errs.len() > 0 {
        print_errs(errs, src_path, &src);
    }

    let tokens = tokens
        .unwrap()
        .into_iter()
        .map(|(token, span)| format!("{}|{}", token, span.end - span.start))
        .collect::<Vec<String>>();
    assert_eq!(
        tokens,
        vec![
            "Id'upd'|3",
            "Op':'|1",
            "Fn|8",
            "Punc'('|1",
            "Id'table'|5",
            "Punc','|1",
            "Id'data'|4",
            "Punc')'|1",
            "Punc'{'|1",
            "Id'table'|5",
            "Op'upsert'|6",
            "Id'data'|4",
            "Punc';'|1",
            "Id'tick'|4",
            "Punc'('|1",
            "Int'1'|1",
            "Punc')'|1",
            "Punc';'|1",
            "Punc'}'|1",
            "Punc';'|1",
            "Id'.sub.init'|9",
            "Op':'|1",
            "Fn|8",
            "Punc'('|1",
            "Punc')'|1",
            "Punc'{'|1",
            "Id'h'|1",
            "Op':'|1",
            "Id'.handle.open'|12",
            "Punc'('|1",
            "Symbol'`chili://:18000:sub1:token789'|29",
            "Punc')'|1",
            "Punc';'|1",
            "Id'.handle.onDisconnected'|22",
            "Punc'('|1",
            "Id'h'|1",
            "Punc','|1",
            "Symbol'`.sub.recover'|13",
            "Punc')'|1",
            "Punc';'|1",
            "Id'info'|4",
            "Op':'|1",
            "Id'h'|1",
            "Punc'('|1",
            "Punc'['|1",
            "Symbol'`.tick.subscribe'|16",
            "Punc','|1",
            "Punc'['|1",
            "Punc']'|1",
            "Punc']'|1",
            "Punc')'|1",
            "Punc';'|1",
            "Punc'('|1",
            "Op'set'|3",
            "Punc')'|1",
            "Op'each'|4",
            "Id'info'|4",
            "Punc'('|1",
            "Int'2'|1",
            "Punc')'|1",
            "Punc';'|1",
            "Comment|37",
            "Id'replay'|6",
            "Punc'('|1",
            "Id'info'|4",
            "Punc'('|1",
            "Int'0'|1",
            "Punc')'|1",
            "Punc','|1",
            "Int'0'|1",
            "Punc','|1",
            "Id'info'|4",
            "Punc'('|1",
            "Int'1'|1",
            "Punc')'|1",
            "Punc','|1",
            "Punc'['|1",
            "Punc']'|1",
            "Punc','|1",
            "Bool'1b'|2",
            "Punc')'|1",
            "Punc';'|1",
            "Id'.handle.subscribing'|19",
            "Punc'('|1",
            "Id'h'|1",
            "Punc')'|1",
            "Punc';'|1",
            "Punc'}'|1",
            "Punc';'|1",
            "Comment|95",
            "Id'.sub.recover'|12",
            "Op':'|1",
            "Fn|8",
            "Punc'('|1",
            "Id'handle'|6",
            "Punc')'|1",
            "Punc'{'|1",
            "Id'.handle.connect'|15",
            "Punc'('|1",
            "Id'handle'|6",
            "Punc')'|1",
            "Punc';'|1",
            "Id'info'|4",
            "Op':'|1",
            "Id'handle'|6",
            "Punc'('|1",
            "Punc'['|1",
            "Symbol'`.tick.subscribe'|16",
            "Punc','|1",
            "Punc'['|1",
            "Punc']'|1",
            "Punc']'|1",
            "Punc')'|1",
            "Punc';'|1",
            "Id'replay'|6",
            "Punc'('|1",
            "Id'info'|4",
            "Punc'('|1",
            "Int'0'|1",
            "Punc')'|1",
            "Punc','|1",
            "Id'tick'|4",
            "Punc'('|1",
            "Int'0'|1",
            "Punc')'|1",
            "Punc','|1",
            "Id'info'|4",
            "Punc'('|1",
            "Int'1'|1",
            "Punc')'|1",
            "Punc','|1",
            "Punc'['|1",
            "Punc']'|1",
            "Punc','|1",
            "Bool'1b'|2",
            "Punc')'|1",
            "Punc';'|1",
            "Id'.handle.subscribing'|19",
            "Punc'('|1",
            "Id'handle'|6",
            "Punc')'|1",
            "Punc';'|1",
            "Punc'}'|1",
            "Punc';'|1",
            "Id'.sub.init'|9",
            "Punc'('|1",
            "Punc')'|1",
            "Punc';'|1"
        ]
    )
}
